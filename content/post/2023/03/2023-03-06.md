+++
author = "aries"
categories = ["tech"]
tags = ["mastodon", "aws"]
date = "2023-03-06"
description = ""
#featured = ""
#featuredalt = ""
featuredpath = "date"
linktitle = ""
title = "mastodonサーバーをLinodeからXserver VPSへ移しました"
type = "post"
toc=true
url = "posts/2023-03-06"
+++

## きっかけ

Akamaiへ買収されたことが記憶に新しいLinodeですが、nanode(RAM1GB/1vCPUの最小サイズ)以外インスタンス自体の価格が20%値上げとのお知らせが入り。

現状mastodon以外を動かしているVMも含めて、大体$35/月(見た目は安いけど円安のせいでこれでも結構する)。

値上げ対象の事を考えると大体値上げ後は$40になる想定で、となると日本円なら5500円くらい。

たかが個人鯖のためにここまで出すのもなぁ……となり移行を決意しました。

## 比較

落ち着いてた円安がまた進んでる為今回は国内サービスを前提にしています。

お金掛けられるならそもそもAWS使うからね……。

Kagoya VPS：ストレージ超安いプランもある。周りであまり良い話を聞かない。IPv6使える。

Xserver VPS：IPv6使えない。サービス側コンソールでの機能がしょぼい(特にFWとかMFAとか)。

WebArena Indigo：周りであまり良い話を聞かない。

さくらのVPS：ちょい高いのと最低利用期間3ヶ月ってのが面倒。あと前に試そうとした時試用期間あるって話だったけどなんかいきなり二ヶ月分請求されるような画面になってて？？？となった

~~記事上げた直後に初期費用ないじゃーんとなって記事修正しました。~~

ConoHa：前に別件で使っててsocks proxy通すとSSH切られまくるのを知ってるから無し。あと他の選択肢と比べるとちょっと高い。


以上の理由からXserver VPSを選択。これもこれで微妙だけどね……。

## 構成

もともと：Linode RAM2GBプラン1台(もっと前はDBとAppで2台構成だった)
これから：Xserver VPS RAM2GBプラン1台

バックアップは今まで通りpostgresqlだけ週一でダンプしてS3へアップロードしてます。

## 移行して良くなかったこと

- Linode側で自動バックアップの機能があったけどXserver VPSにはそんな便利な機能は無い
  - ので、何かあった時サーバーが死ぬ確率が上がった
- 見かけだけのIPv6対応ができなくなった
  - 元々docker内で特に突っ込んだ設定せず、AAAAだけ向けてたのもあってIPv6での連合は多分してなかったはず
  - 私はv6のみのクライアント環境持ってないから、特に対応しなくてもいいでしょという判断
- streamingコンテナが要求するメモリが増えた
  - 128MBから256MB
- docker-compose.ymlの中でIPアドレスレンジを指定するのがおっくうであんまりちゃんとFW使えていない
  - 1インスタンスでホスト側でDB、コンテナ側でAppって形にするとありがち
  - SSH用に使ってるzerotierのipアドレスにDBをbindすることで対応した
  - xserver vpsにはプライベートネットワークなどの機能は無い
  - この辺クソなので、やっぱりAppサーバーとDBサーバーのVPSをそもそも分ける方が楽だなぁ……と再確認した(去年の円安前まではLinodeインスタンス2つで動かしてたので)
- 金額かなり安くなった(はず)

## 移行して良かったこと

バックアップスクリプトとリストアのテストができた。

## 移行手順

たいしたことないけど書いときます。

- 新VPS初期設定
- 旧サーバーサービス停止
- DBダンプ `sudo -Hu postgres pg_dumpall |gzip - > /tmp/pg_dumpall.gz`
- DNS設定
- DBリストア `zcat /tmp/pg_dumpall.gz | psql -f -`
