+++
author = "aries"
categories = ["tech"]
tags = ["Hugo", "AWS", "é™çš„ã‚µã‚¤ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿"]
date = "2019-07-21"
description = "Hugo+Github+CodeBuild+S3+CloudFront+Lambda@Edgeãªãƒ–ãƒ­ã‚°"
#featured = ""
#featuredalt = ""
featuredpath = "date"
linktitle = ""
title = "S3+CloudFrontã§ã‚‚Observatoryé«˜ã‚¹ã‚³ã‚¢ã‚’å–ã‚ŠãŸã„"
type = "post"
toc=true
+++

Aç›®æ¨™ã§ã—ãŸãŒç„¡ç†ã¨åˆ¤æ–­ã—ãŸã®ã§ç¾åœ¨Bã§ã™ã€‚

# çµŒç·¯

- é™çš„ã‚µã‚¤ãƒˆã ã—CDNé€šã—ã¦ã‚‹ã—ã§PageSpeed Insightsã ã¨80å¾ŒåŠ~100å‡ºã‚‹
- SSLã¯CDNä»»ã›ã§ååˆ†
- ã˜ã‚ƒæ®‹ã‚Šã¯ï¼Ÿ

ã§Observatoryã®ã‚¹ã‚³ã‚¢ã‚’ä¸Šã’ã¦ã¿ã‚ˆã†ã¨æ±ºæ„ã€‚ECã‚µã‚¤ãƒˆã¨ã‹ã§ã¯ãªã„ã®ã§ã©ã‚Œã ã‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ°—ã«ã—ã¦ã‚‚ãã‚“ãªã«æ„å‘³ã‚ã‚‹ã‹ãªãâ€¦ã¨ã„ã†æ„Ÿã˜ã¯ã‚ã‚Šã¾ã™ãŒã€‚

# çµæœ

Fãƒ©ãƒ³ã‚¯ã ã£ãŸObservatoryã‚¹ã‚³ã‚¢ãŒBãƒ©ãƒ³ã‚¯ã«ãªã‚Šã¾ã—ãŸğŸ‰

# å…ƒã®æ§‹æˆ

ä»Šå›ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ã“ã®ãƒ–ãƒ­ã‚°ã¨ https://www.asterism.xyz ã®2ã¤ã§ã™ã€‚

6æœˆé ƒã¾ã§ã¯CodeCommitã‚’ã‚µã‚¤ãƒˆã®ãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦ä½¿ã£ã¦ã„ã¾ã—ãŸãŒãƒªãƒã‚¸ãƒˆãƒªã‚’è³‘ã‚„ã‹ã™ãŸã‚GitHubã«ç§»è¡Œã—ã¾ã—ãŸã€‚(ä¸ç´”)

ã‚µã‚¤ãƒˆã®é…ä¿¡ã¯S3ã¨CloudFrontã‚’ä½¿ã£ã¦ã„ã¦ã€

- Hugo themeã¯git submoduleã§ç®¡ç†
- GitHubãƒªãƒã‚¸ãƒˆãƒªã®æ›´æ–°ãŒã‚ã‚‹ã¨ã€Webhookã§CodeBuildã‚’èµ·å‹•
- buildspecã§ã¯Hugoã‚µã‚¤ãƒˆã®buildã€S3ãƒã‚±ãƒƒãƒˆã®æ›´æ–°ã€CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢

ã¨ã„ã†ã‚ˆã†ã«å‹•ã„ã¦ã„ã¾ã™ã€‚

PageSpeedã¯ä½¿ã†themeã«ã‚ˆã‚Šã‘ã‚Šã§ã¯ã‚ã‚Šã¾ã™ãŒã€ãƒ¢ãƒã‚¤ãƒ«80ç‚¹PC90ç‚¹ä»¥ä¸Šã¯å¤§ä½“ã§ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªãƒ¼ã¨ã‹æ€ã£ã¦ã¾ã™ã€‚

ã¡ãªã¿ã«Hugo Future Imperfect Slimã¨ã„ã†themeã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã®ã‚µã‚¤ãƒˆã§ã¯ãƒ¢ãƒã‚¤ãƒ«88ç‚¹PC100ç‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

SSLLABSã¯CloudFrontä»»ã›ã§ã‚¹ã‚³ã‚¢Aå–ã‚Œã¾ã™ã€‚

ãŸã ã—Observatoryã§è¦‹ã‚‹ã¨å¦™ã«ã‚¹ã‚³ã‚¢ãŒä½ã„â€¦ã€‚

# å•é¡Œç‚¹

Observatoryã®ãƒ†ã‚¹ãƒˆçµæœã‚’è¦‹ã‚‹ã¨ã€ã©ã†ã‚„ã‚‰HSTSã¨ã‹CSPã¨ã‹X-Content-Type-Optionsã¨ã‹X-Frame-Optionsã¨ã‹X-XSS-Protectionãªã©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨httpãƒ˜ãƒƒãƒ€ãŒç„¡ã„ã‚ˆã¨ã®äº‹ã€‚

webã‚µãƒ¼ãƒã‚’ä½¿ã£ã¦ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã„ã‚‹å ´åˆã¯ã¡ã‚‡ã“ã£ã¨è¨­å®šã‚’å¤‰ãˆã¦ã€+ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å´ã§å¿…è¦ã§ã‚ã‚Œã°å¯¾å¿œã¨ã„ã†ã ã‘ã§çµ‚ã‚ã‚Šã§ã™ãŒä¸Šè¨˜ã®é€šã‚ŠS3+CDNã¨ã„ã†æ§‹æˆã§ã™ã€‚

ãªã«ã‹å¼„ã‚‹æ–¹æ³•ç„¡ã„ã®ã‹ãªã¨æ€ã£ã¦èª¿ã¹ãŸæ‰€æ¡ˆã®å®šã‚ã‚Šã¾ã—ãŸã€‚AWSã£ã¦å‡ºæ¥ãªã„ã“ã¨ãŒãªã„ã®ã§ã¯ã¨æ€ã†ãã‚‰ã„ã«ã‚µãƒ¼ãƒ“ã‚¹å¤šã„ã§ã™ã‚ˆã­ãƒ›ãƒ³ãƒˆã€‚

https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/lambda-edge-how-it-works-tutorial.html

# ä½œæ¥­

Lambda@Edgeã¯CloudFrontã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«Lambdaã‚’å‹•ã‹ã›ã¾ã™ã‚ˆãƒ¼ã€ã£ã¦ã‚„ã¤ã®ã‚ˆã†ã§ã™ã­ã€‚

å®Ÿã¯mastodonã¨pleromaã®ãƒ¡ãƒ‡ã‚£ã‚¢ã«ã¯CloudFrontã§ã¯ãªãCloudflareã‚’ä½¿ã£ã¦ã„ã¦ã€ã“ã®ãƒ–ãƒ­ã‚°ã®CDNã‚‚ä¸€æ™‚æœŸCloudflareã«ç§»ã—ã¦ã„ã¾ã—ãŸã€‚

ãŸã Lambda@Edgeã§ãƒ˜ãƒƒãƒ€æ›¸ãæ›ãˆãŒæ¥½ã«ã§ãã‚‹ã¨ã„ã†äº‹ãŒåˆ†ã‹ã£ãŸã®ã§ç§»è¡Œã¯ã‚„ã‚ã“ã¡ã‚‰ã«æ®‹ç•™ã€‚

ä½œæ¥­å†…å®¹ã¨ã—ã¦ã¯ä¸Šã®URLãŒã»ã¼å…¨ã¦ã§ã™ã€‚

ä¸€å¿œindex.jsã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¹—ã›ã¦ãŠãã¨ã€

```
'use strict';
exports.handler = (event, context, callback) => {
    
    //Get contents of response
    const response = event.Records[0].cf.response;
    const headers = response.headers;

//Set new headers 
 headers['strict-transport-security'] = [{key: 'Strict-Transport-Security', value: 'max-age=15768000; preload'}]; 
 headers['x-content-type-options'] = [{key: 'X-Content-Type-Options', value: 'nosniff'}]; 
 headers['x-frame-options'] = [{key: 'X-Frame-Options', value: 'DENY'}]; 
 headers['x-xss-protection'] = [{key: 'X-XSS-Protection', value: '1; mode=block'}]; 
 headers['referrer-policy'] = [{key: 'Referrer-Policy', value: 'same-origin'}]; 
    
    //Return modified response
    callback(null, response);
};
```

ä½œæ¥­é †ã¯

- HSTSã¨CSPã¯é¢å€’ãªã®ã§ä¸€æ—¦ç„¡ã—ã§ä»–ã®ãƒ˜ãƒƒãƒ€ã‚’è¿½åŠ ã—ã‚¹ã‚³ã‚¢ãŒä¸ŠãŒã‚‹ã“ã¨ã‚’ç¢ºèª
- https://www.asterism.xyz ã§ä½¿ã£ã¦ã„ã‚‹Hugo-academicã ã¨ãƒ˜ãƒƒãƒ€ä»¥å¤–ã®æ¸›ç‚¹è¦ç´ ã¨ã—ã¦URLã‚¹ã‚­ãƒ¼ãƒ ç„¡ã—ã§èª­ã¿è¾¼ã‚“ã§ã‚‹å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã£ãŸãŸã‚ãã‚Œã‚‰ã‚’ä¿®æ­£(PullRequestå–ã‚Šè¾¼ã¾ã‚Œã¾ã—ãŸâœŒ)
  - https://github.com/gcushen/hugo-academic/pull/1213

- HSTSã‚’è¨­å®š
- CSPå¯¾å¿œã‚‚ã—ã‚ˆã†ã¨ã—ãŸã‘ã©ä»Šä½¿ã£ã¦ã„ã‚‹themeã ã¨ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚’ç„¡ãã™ã®ã¯ç§ã®æŠ€é‡ã§ã¯ã‚ã£ã¡ã‚ƒæ™‚é–“ã‹ã‹ã‚Šãã†ã ã¨åˆ¤æ–­ã—ä»Šã¯æ–­å¿µ

ã¨ã„ã£ãŸæ„Ÿã˜ã€‚

ãªã‚“ã§CSPé§„ç›®ã ã£ãŸã‹ã¨è¨€ã†ã¨ã€ä¸»ã«Hugoã®GoogleAnalyticså¯¾å¿œã®ã›ã„ã§ã—ã¦â€¦â€¦ã€‚

[hugo|github](https://github.com/gohugoio/hugo/blob/b2a3d4644bb5a505db662b2927af6f80856a3076/tpl/tplimpl/embedded/templates.autogen.go#L114)

è¦‹ã¦ã®é€šã‚Šã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã•ã‚Œã¦ãŠã‚Šã€ã“ã†ãªã£ã¡ã‚ƒã†ã¨ä»•æ–¹ãªã„ãªãã¨ã€‚

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§nonceè¨­å®šã§ãã‚‹ã¨ã„ã„ã‚“ã§ã™ãŒã€‚

é‡‘é¡çš„ã«ã¯ä¸Šã®Lambdaã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å®Ÿè¡Œæ™‚é–“çŸ­ã„ã—ã€å¯¾ã—ã¦PVãŒã‚ã‚‹ã‚µã‚¤ãƒˆã§ã‚‚ãªã„ãŸã‚ã»ã¼ã‹ã‹ã£ã¦ãªã„ã§ã™ã€‚
